{% extends "base.html" %}
{% block title %}Game History{% endblock %}
{% block body_class %}admin-page{% endblock %}
{% block header %}
  <img src="/static/Logo-01.png" alt="Game Logo" class="brand-logo">
{% endblock %}
{% block content %}
<section>
  <h2>Recent Sessions — {{ game_id }}</h2>
  <p id="historyStatus" class="status small">Loading…</p>
  <table class="table" id="historyTable" style="margin-top:8px;">
    <thead>
      <tr>
        <th>Started</th>
        <th>Kiosk</th>
        <th>Session</th>
        <th>Player</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>
<script>
(function(){
  const gameId = "{{ game_id }}";
  const statusEl = document.getElementById('historyStatus');
  const tbody = document.querySelector('#historyTable tbody');

  function fmt(ts){
    if (!ts) return '';
    try {
      const d = new Date(ts);
      return d.toLocaleString();
    } catch { return ts; }
  }

  async function loadHistory(){
    try {
      statusEl.textContent = 'Loading…';
      const resp = await fetch(`/games/${encodeURIComponent(gameId)}/history`);
      if (!resp.ok) {
        statusEl.textContent = 'Failed to load history.';
        return;
      }
      const data = await resp.json();
      const rows = data.sessions || [];
      tbody.innerHTML = '';
      for (const s of rows) {
        const players = s.players && s.players.length ? s.players : [{player_id:null, username:'—', score:null}];
        for (const p of players) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmt(s.started_at)}</td>
            <td>${s.kiosk_id || ''}</td>
            <td>${s.session_id}</td>
            <td>${p.username ?? ('#'+p.player_id)}</td>
            <td>${p.score ?? ''}</td>
          `;
          tbody.appendChild(tr);
        }
      }
      statusEl.textContent = rows.length ? `Showing ${rows.length} recent sessions.` : 'No sessions found for this game.';
    } catch (e) {
      console.error('Failed to load history', e);
      statusEl.textContent = 'Error while loading history.';
    }
  }

  loadHistory();
})();
</script>
{% endblock %}
